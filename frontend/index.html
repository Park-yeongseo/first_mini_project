<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÏùºÏ†ï Í¥ÄÎ¶¨ ÎßàÏä§ÌÑ∞</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 20px 30px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 28px;
            font-weight: bold;
            color: #4a90e2;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .logo::before {
            content: "üìÖ";
            font-size: 32px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-welcome {
            color: #666;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #4a90e2;
            color: white;
        }

        .btn-primary:hover {
            background: #357abd;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #dee2e6;
        }

        .btn-secondary:hover {
            background: #e9ecef;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        /* Navigation */
        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .nav-tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s ease;
        }

        .nav-tab.active {
            background: #4a90e2;
            color: white;
        }

        .nav-tab:hover:not(.active) {
            background: #f8f9fa;
        }

        /* Content Areas */
        .content-area {
            display: none;
            background: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 30px;
            margin-bottom: 30px;
        }

        .content-area.active {
            display: block;
        }

        /* Auth Forms */
        .auth-container {
            max-width: 400px;
            margin: 50px auto;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }

        .auth-title {
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
            color: #4a90e2;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: #4a90e2;
        }

        .auth-switch {
            text-align: center;
            margin-top: 20px;
            color: #666;
        }

        .auth-switch a {
            color: #4a90e2;
            text-decoration: none;
        }

        /* Chat Interface */
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 600px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .message {
            margin-bottom: 15px;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            word-wrap: break-word;
        }

        .message.user .message-content {
            background: #4a90e2;
            color: white;
        }

        .message.assistant .message-content {
            background: white;
            border: 1px solid #e9ecef;
        }

        .task-input-container {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .task-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border: 1px solid #e9ecef;
        }

        .task-item input, .task-item textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .chat-input-area {
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: 25px;
            font-size: 16px;
        }

        .chat-input:focus {
            outline: none;
            border-color: #4a90e2;
        }

        .send-btn {
            padding: 12px 20px;
            background: #4a90e2;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 500;
        }

        /* Routine Management */
        .routine-week {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .day-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }

        .day-card:hover {
            border-color: #4a90e2;
        }

        .day-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #4a90e2;
            text-align: center;
        }

        .routine-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .routine-info {
            flex: 1;
        }

        .routine-title {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .routine-time {
            font-size: 12px;
            color: #666;
        }

        .routine-actions {
            display: flex;
            gap: 5px;
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 12px;
            border-radius: 5px;
        }

        /* Plan Table */
        .plan-table {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .plan-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #4a90e2;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .plan-time {
            font-weight: bold;
            color: #4a90e2;
            margin-right: 15px;
        }

        .plan-content {
            flex: 1;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #4a90e2;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .checkbox-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin: 15px 0;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4a90e2;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }

            .nav-tabs {
                flex-wrap: wrap;
            }

            .routine-week {
                grid-template-columns: 1fr;
            }

            .chat-container {
                height: 500px;
            }
        }

        .hidden {
            display: none !important;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }

        .alert-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }

        .alert-info {
            background: #cce7ff;
            border: 1px solid #99d3ff;
            color: #004085;
        }
    </style>
</head>
<body>
    <!-- Î°úÍ∑∏Ïù∏/ÌöåÏõêÍ∞ÄÏûÖ ÌôîÎ©¥ -->
    <div id="authScreen" class="auth-container">
        <div id="loginForm">
            <h2 class="auth-title">ÏùºÏ†ï Í¥ÄÎ¶¨ ÎßàÏä§ÌÑ∞</h2>
            <div id="loginAlert"></div>
            <form id="loginFormElement">
                <div class="form-group">
                    <label class="form-label">ÏïÑÏù¥Îîî</label>
                    <input type="text" id="loginId" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                    <input type="password" id="loginPassword" class="form-input" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Î°úÍ∑∏Ïù∏</button>
            </form>
            <div class="auth-switch">
                Í≥ÑÏ†ïÏù¥ ÏóÜÏúºÏã†Í∞ÄÏöî? <a href="#" onclick="showRegister()">ÌöåÏõêÍ∞ÄÏûÖ</a>
            </div>
        </div>

        <div id="registerForm" class="hidden">
            <h2 class="auth-title">ÌöåÏõêÍ∞ÄÏûÖ</h2>
            <div id="registerAlert"></div>
            <form id="registerFormElement">
                <div class="form-group">
                    <label class="form-label">ÏïÑÏù¥Îîî (5Ïûê Ïù¥ÏÉÅ)</label>
                    <input type="text" id="regLoginId" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Ïù¥Î¶Ñ</label>
                    <input type="text" id="regName" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ÎπÑÎ∞ÄÎ≤àÌò∏ (8Ïûê Ïù¥ÏÉÅ, ÌäπÏàòÎ¨∏Ïûê Ìè¨Ìï®)</label>
                    <input type="password" id="regPassword" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ÎÇòÏù¥</label>
                    <input type="number" id="regAge" class="form-input" required min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Ïù¥Î©îÏùº</label>
                    <input type="email" id="regEmail" class="form-input" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">ÌöåÏõêÍ∞ÄÏûÖ</button>
            </form>
            <div class="auth-switch">
                Ïù¥ÎØ∏ Í≥ÑÏ†ïÏù¥ ÏûàÏúºÏã†Í∞ÄÏöî? <a href="#" onclick="showLogin()">Î°úÍ∑∏Ïù∏</a>
            </div>
        </div>
    </div>

    <!-- Î©îÏù∏ Ïï†ÌîåÎ¶¨ÏºÄÏù¥ÏÖò ÌôîÎ©¥ -->
    <div id="mainApp" class="hidden">
        <div class="container">
            <!-- Ìó§Îçî -->
            <div class="header">
                <div class="logo">ÏùºÏ†ï Í¥ÄÎ¶¨ ÎßàÏä§ÌÑ∞</div>
                <div class="user-info">
                    <span class="user-welcome" id="userWelcome">ÌôòÏòÅÌï©ÎãàÎã§!</span>
                    <button class="btn btn-secondary" onclick="showProfile()">ÎÇ¥ Ï†ïÎ≥¥</button>
                    <button class="btn btn-danger" onclick="logout()">Î°úÍ∑∏ÏïÑÏõÉ</button>
                </div>
            </div>

            <!-- ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò -->
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('dashboard')">ÎåÄÏãúÎ≥¥Îìú</button>
                <button class="nav-tab" onclick="showTab('chat')">AI ÏùºÏ†ï ÌîåÎûòÎÑà</button>
                <button class="nav-tab" onclick="showTab('routine')">Î£®Ìã¥ Í¥ÄÎ¶¨</button>
                <button class="nav-tab" onclick="showTab('plans')">Í≥ÑÌöçÌëú Í¥ÄÎ¶¨</button>
            </div>

            <!-- ÎåÄÏãúÎ≥¥Îìú -->
            <div id="dashboardTab" class="content-area active">
                <h2>Ïò§ÎäòÏùò ÏùºÏ†ï</h2>
                <div id="todayPlan"></div>
                <div id="motivationQuote" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-top: 20px; text-align: center; font-style: italic;"></div>
            </div>

            <!-- AI ÏùºÏ†ï ÌîåÎûòÎÑà -->
            <div id="chatTab" class="content-area">
                <h2>AI ÏùºÏ†ï ÌîåÎûòÎÑà</h2>
                <div class="task-input-container">
                    <h3>Ïò§Îäò Ìï† ÏùºÏùÑ Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî</h3>
                    <div id="taskList"></div>
                    <button class="btn btn-secondary" onclick="addTask()">+ Ìï† Ïùº Ï∂îÍ∞Ä</button>
                </div>
                
                <div class="chat-container">
                    <div class="chat-messages" id="chatMessages"></div>
                    <div class="chat-input-area">
                        <input type="text" id="chatInput" class="chat-input" placeholder="AIÏóêÍ≤å ÏùºÏ†ï Í≥ÑÌöçÏùÑ ÏöîÏ≤≠Ìï¥Î≥¥ÏÑ∏Ïöî...">
                        <button class="send-btn" onclick="sendChatMessage()">Ï†ÑÏÜ°</button>
                    </div>
                </div>
                
                <div class="loading" id="chatLoading">
                    <div class="spinner"></div>
                    <p>AIÍ∞Ä ÏùºÏ†ïÏùÑ Í≥ÑÌöçÌïòÍ≥† ÏûàÏäµÎãàÎã§...</p>
                </div>
            </div>

            <!-- Î£®Ìã¥ Í¥ÄÎ¶¨ -->
            <div id="routineTab" class="content-area">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2>Î£®Ìã¥ Í¥ÄÎ¶¨</h2>
                    <button class="btn btn-primary" onclick="showAddRoutineModal()">+ Î£®Ìã¥ Ï∂îÍ∞Ä</button>
                </div>
                <div class="routine-week" id="routineWeek"></div>
            </div>

            <!-- Í≥ÑÌöçÌëú Í¥ÄÎ¶¨ -->
            <div id="plansTab" class="content-area">
                <h2>Í≥ÑÌöçÌëú Í¥ÄÎ¶¨</h2>
                <div id="plansList"></div>
            </div>
        </div>
    </div>

    <!-- Î£®Ìã¥ Ï∂îÍ∞Ä Î™®Îã¨ -->
    <div id="routineModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Î£®Ìã¥ Ï∂îÍ∞Ä</h3>
                <button class="close-btn" onclick="closeModal('routineModal')">&times;</button>
            </div>
            <form id="routineForm">
                <div class="form-group">
                    <label class="form-label">Ï†úÎ™©</label>
                    <input type="text" id="routineTitle" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">ÏãúÍ∞Ñ</label>
                    <input type="time" id="routineTime" class="form-input">
                </div>
                <div class="form-group">
                    <label class="form-label">ÏÜåÏöî ÏãúÍ∞Ñ (Î∂Ñ)</label>
                    <input type="number" id="routineDuration" class="form-input" min="1">
                </div>
                <div class="form-group">
                    <label class="form-label">ÏãúÍ∞ÑÎåÄ</label>
                    <select id="routineTimeZone" class="form-input">
                        <option value="">ÏãúÍ∞ÑÎåÄ ÏÑ†ÌÉù</option>
                        <option value="ÏÉàÎ≤Ω">ÏÉàÎ≤Ω (05:00 - 07:59)</option>
                        <option value="ÏïÑÏπ®">ÏïÑÏπ® (08:00 - 11:59)</option>
                        <option value="Ï†êÏã¨">Ï†êÏã¨ (12:00 - 17:59)</option>
                        <option value="Ï†ÄÎÖÅ">Ï†ÄÎÖÅ (18:00 - 23:59)</option>
                        <option value="Î∞§">Î∞§ (00:00 - 04:59)</option>
                    </select>
                </div>
                <div class="form-group" id="weekdaySelection">
                    <label class="form-label">ÏöîÏùº ÏÑ†ÌÉù</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="monday"> <label for="monday">Ïõî</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="tuesday"> <label for="tuesday">Ìôî</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="wednesday"> <label for="wednesday">Ïàò</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="thursday"> <label for="thursday">Î™©</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="friday"> <label for="friday">Í∏à</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="saturday"> <label for="saturday">ÌÜ†</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="sunday"> <label for="sunday">Ïùº</label>
                        </div>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;" id="routineSubmitBtn">Î£®Ìã¥ Ï∂îÍ∞Ä</button>
            </form>
        </div>
    </div>

    <!-- ÌîÑÎ°úÌïÑ Î™®Îã¨ -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">ÎÇ¥ Ï†ïÎ≥¥</h3>
                <button class="close-btn" onclick="closeModal('profileModal')">&times;</button>
            </div>
            <div id="profileContent"></div>
        </div>
    </div>

    <script>
        // Ï†ÑÏó≠ Î≥ÄÏàò
        let currentUser = null;
        let authToken = null;
        let tasks = [];

        // API Í∏∞Î≥∏ ÏÑ§Ï†ï
        const API_BASE = 'http://localhost:8000'; // Î∞±ÏóîÎìú ÏÑúÎ≤Ñ Ï£ºÏÜå Î™ÖÏãú

        // Ïú†Ìã∏Î¶¨Ìã∞ Ìï®Ïàò
        function showAlert(message, type = 'info', containerId = null) {
            const alertClass = type === 'success' ? 'alert-success' : 
                              type === 'error' ? 'alert-error' : 'alert-info';
            const alert = `<div class="alert ${alertClass}">${message}</div>`;
            
            if (containerId) {
                document.getElementById(containerId).innerHTML = alert;
                setTimeout(() => {
                    document.getElementById(containerId).innerHTML = '';
                }, 5000);
            } else {
                // Ï†ÑÏó≠ ÏïåÎ¶º
                console.log(message);
            }
        }

        function formatTime(timeStr) {
            if (!timeStr) return '';
            return timeStr.slice(0, 5);
        }

        // API Ìò∏Ï∂ú Ìï®Ïàò
        async function apiCall(endpoint, method = 'GET', data = null, useAuth = true) {
            const config = {
                method,
                headers: {
                    'Content-Type': 'application/json'
                }
            };

            if (useAuth && authToken) {
                config.headers['Authorization'] = `Bearer ${authToken}`;
            }

            if (data) {
                config.body = JSON.stringify(data);
            }

            try {
                console.log(`API Ìò∏Ï∂ú: ${method} ${API_BASE + endpoint}`);
                console.log('ÏöîÏ≤≠ Îç∞Ïù¥ÌÑ∞:', data);
                
                const response = await fetch(API_BASE + endpoint, config);
                
                console.log('ÏùëÎãµ ÏÉÅÌÉú:', response.status, response.statusText);
                console.log('ÏùëÎãµ Ìó§Îçî:', response.headers);
                
                // ÏùëÎãµÏù¥ ÎπÑÏñ¥ÏûàÎäîÏßÄ ÌôïÏù∏
                const text = await response.text();
                console.log('ÏùëÎãµ ÌÖçÏä§Ìä∏:', text);
                
                if (!text) {
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return null;
                }
                
                let result;
                try {
                    result = JSON.parse(text);
                } catch (jsonError) {
                    console.error('JSON ÌååÏã± Ïò§Î•ò:', text);
                    throw new Error(`ÏÑúÎ≤Ñ ÏùëÎãµÏùÑ ÌååÏã±Ìï† Ïàò ÏóÜÏäµÎãàÎã§. ÏùëÎãµ: ${text.substring(0, 100)}`);
                }
                
                if (!response.ok) {
                    throw new Error(result.detail || result.message || `HTTP ${response.status}: ${response.statusText}`);
                }
                
                return result;
            } catch (error) {
                if (error.name === 'TypeError' && error.message.includes('fetch')) {
                    throw new Error('ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§. Î∞±ÏóîÎìú ÏÑúÎ≤ÑÍ∞Ä Ïã§Ìñâ Ï§ëÏù∏ÏßÄ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
                }
                console.error('API Ìò∏Ï∂ú Ïò§Î•ò:', error);
                throw error;
            }
        }

        // Ïù∏Ï¶ù Í¥ÄÎ†® Ìï®Ïàò
        async function login() {
            const loginId = document.getElementById('loginId').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            if (!loginId || !password) {
                showAlert('ÏïÑÏù¥ÎîîÏôÄ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error', 'loginAlert');
                return;
            }

            try {
                console.log('Î°úÍ∑∏Ïù∏ ÏãúÎèÑ:', { login_id: loginId });
                
                const result = await apiCall('/login', 'POST', {
                    login_id: loginId,
                    password: password
                }, false);

                console.log('Î°úÍ∑∏Ïù∏ ÏùëÎãµ:', result);

                if (result && result.access_token) {
                    authToken = result.access_token;
                    localStorage.setItem('authToken', authToken);
                    
                    // ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
                    currentUser = await apiCall('/me');
                    
                    showMainApp();
                    loadDashboard();
                    loadRoutines();
                    showAlert('Î°úÍ∑∏Ïù∏ÎêòÏóàÏäµÎãàÎã§!', 'success');
                } else {
                    throw new Error('ÌÜ†ÌÅ∞ÏùÑ Î∞õÏùÑ Ïàò ÏóÜÏäµÎãàÎã§.');
                }
            } catch (error) {
                console.error('Î°úÍ∑∏Ïù∏ Ïò§Î•ò:', error);
                showAlert(error.message, 'error', 'loginAlert');
            }
        }

        async function register() {
            const loginId = document.getElementById('regLoginId').value.trim();
            const name = document.getElementById('regName').value.trim();
            const password = document.getElementById('regPassword').value.trim();
            const age = document.getElementById('regAge').value;
            const email = document.getElementById('regEmail').value.trim();

            // Í∏∞Î≥∏ Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
            if (!loginId || !name || !password || !age || !email) {
                showAlert('Î™®Îì† ÌïÑÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error', 'registerAlert');
                return;
            }

            if (loginId.length < 5) {
                showAlert('ÏïÑÏù¥ÎîîÎäî 5Ïûê Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§.', 'error', 'registerAlert');
                return;
            }

            if (password.length < 8) {
                showAlert('ÎπÑÎ∞ÄÎ≤àÌò∏Îäî 8Ïûê Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§.', 'error', 'registerAlert');
                return;
            }

            const formData = {
                login_id: loginId,
                name: name,
                password: password,
                age: parseInt(age),
                email: email,
                routine: {
                    monday: [],
                    tuesday: [],
                    wednesday: [],
                    thursday: [],
                    friday: [],
                    saturday: [],
                    sunday: []
                }
            };

            try {
                console.log('ÌöåÏõêÍ∞ÄÏûÖ ÏãúÎèÑ:', formData);
                
                const result = await apiCall('/register', 'POST', formData, false);
                
                console.log('ÌöåÏõêÍ∞ÄÏûÖ ÏùëÎãµ:', result);
                
                showAlert('ÌöåÏõêÍ∞ÄÏûÖÏù¥ ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§! Î°úÍ∑∏Ïù∏Ìï¥Ï£ºÏÑ∏Ïöî.', 'success', 'registerAlert');
                setTimeout(() => {
                    showLogin();
                    // Ìèº Ï¥àÍ∏∞Ìôî
                    document.getElementById('registerFormElement').reset();
                }, 2000);
            } catch (error) {
                console.error('ÌöåÏõêÍ∞ÄÏûÖ Ïò§Î•ò:', error);
                showAlert(error.message, 'error', 'registerAlert');
            }
        }

        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('authScreen').classList.remove('hidden');
            showLogin();
        }

        // ÌôîÎ©¥ Ï†ÑÌôò Ìï®Ïàò
        function showLogin() {
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('registerForm').classList.add('hidden');
            document.getElementById('loginAlert').innerHTML = '';
        }

        function showRegister() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('registerForm').classList.remove('hidden');
            document.getElementById('registerAlert').innerHTML = '';
        }

        function showMainApp() {
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userWelcome').textContent = `${currentUser.name}Îãò ÌôòÏòÅÌï©ÎãàÎã§!`;
        }

        function showTab(tabName) {
            // Î™®Îì† ÌÉ≠ ÎπÑÌôúÏÑ±Ìôî
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.content-area').forEach(area => area.classList.remove('active'));
            
            // ÏÑ†ÌÉùÎêú ÌÉ≠ ÌôúÏÑ±Ìôî
            event.target.classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');

            // ÌÉ≠Î≥Ñ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            if (tabName === 'routine') {
                loadRoutines();
            } else if (tabName === 'plans') {
                loadPlans();
            } else if (tabName === 'dashboard') {
                loadDashboard();
            }
        }

        // ÎåÄÏãúÎ≥¥Îìú Î°úÎìú
        async function loadDashboard() {
            try {
                console.log('ÎåÄÏãúÎ≥¥Îìú Î°úÎî© ÏãúÏûë...');
                const result = await apiCall('/api/default-content');
                console.log('ÎåÄÏãúÎ≥¥Îìú Îç∞Ïù¥ÌÑ∞:', result);
                
                const container = document.getElementById('todayPlan');
                
                if (typeof result === 'string') {
                    container.innerHTML = `
                        <div style="text-align: center; color: #666; padding: 40px;">
                            <h3>üìÖ Ïò§ÎäòÏùò ÏùºÏ†ï</h3>
                            <p>${result}</p>
                            <button class="btn btn-primary" onclick="showTab('chat')" style="margin-top: 15px;">
                                AIÎ°ú ÏùºÏ†ï ÎßåÎì§Í∏∞
                            </button>
                        </div>
                    `;
                } else if (Array.isArray(result) && result.length > 0) {
                    let html = '<div class="plan-table"><h3>üìÖ Ïò§ÎäòÏùò Í≥ÑÌöç</h3>';
                    result.forEach(item => {
                        html += `
                            <div class="plan-item">
                                <span class="plan-time">${item.time || ''}</span>
                                <div class="plan-content">
                                    <strong>${item.title || item.task || 'ÏùºÏ†ï'}</strong>
                                    ${item.description ? `<br><small>${item.description}</small>` : ''}
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; color: #666; padding: 40px;">
                            <h3>üìÖ Ïò§ÎäòÏùò ÏùºÏ†ï</h3>
                            <p>Ïò§ÎäòÏùò Í≥ÑÌöçÏù¥ ÏóÜÏäµÎãàÎã§.</p>
                            <button class="btn btn-primary" onclick="showTab('chat')" style="margin-top: 15px;">
                                AIÎ°ú ÏùºÏ†ï ÎßåÎì§Í∏∞
                            </button>
                        </div>
                    `;
                }

                // ÎèôÍ∏∞Î∂ÄÏó¨ Î™ÖÏñ∏ ÌëúÏãú
                showMotivationQuote();
            } catch (error) {
                console.error('ÎåÄÏãúÎ≥¥Îìú Î°úÎî© Ïò§Î•ò:', error);
                document.getElementById('todayPlan').innerHTML = `
                    <div style="text-align: center; color: #666; padding: 40px;">
                        <h3>üìÖ Ïò§ÎäòÏùò ÏùºÏ†ï</h3>
                        <p>ÎåÄÏãúÎ≥¥ÎìúÎ•º Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</p>
                        <p style="color: #999; font-size: 14px;">ÏÑúÎ≤Ñ Ïó∞Í≤∞ÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.</p>
                        <button class="btn btn-primary" onclick="loadDashboard()" style="margin-top: 15px;">
                            Îã§Ïãú ÏãúÎèÑ
                        </button>
                    </div>
                `;
            }
        }

        function showMotivationQuote() {
            const quotes = [
                {"author": "ÏóêÏù¥Î∏åÎü¨ÌñÑ ÎßÅÏª®", "message": "ÎÇòÎäî Ï≤úÏ≤úÌûà Í±∑ÏßÄÎßå, Í≤∞ÏΩî Îí§Î°ú Í±∑ÏßÄ ÏïäÎäîÎã§."},
                {"author": "ÎßàÌïòÌä∏Îßà Í∞ÑÎîî", "message": "ÌñâÎèôÏùÄ Ïö∞ÏÑ†ÏàúÏúÑÎ•º ÎìúÎü¨ÎÇ∏Îã§."},
                {"author": "Ìó®Î¶¨ Ìè¨Îìú", "message": "Ìï† Ïàò ÏûàÎã§Í≥† ÏÉùÍ∞ÅÌïòÎì†, Ìï† Ïàò ÏóÜÎã§Í≥† ÏÉùÍ∞ÅÌïòÎì†, ÎãπÏã†Ïù¥ Ïò≥Îã§."},
                {"author": "ÏúàÏä§ÌÑ¥ Ï≤òÏπ†", "message": "ÏÑ±Í≥µÏù¥ ÎÅùÏù¥ ÏïÑÎãàÍ≥†, Ïã§Ìå®Í∞Ä ÏπòÎ™ÖÏ†ÅÏù¥ÏßÄÎèÑ ÏïäÎã§. Ï§ëÏöîÌïú Í≤ÉÏùÄ Í≥ÑÏÜç ÎÇòÏïÑÍ∞ÄÎäî Ïö©Í∏∞Îã§."},
                {"author": "ÏïåÎ≤ÑÌä∏ ÏïÑÏù∏ÏäàÌÉÄÏù∏", "message": "ÏÑ±Í≥µÌïú ÏÇ¨ÎûåÏù¥ ÎêòÎ†§Í≥† ÌïòÏßÄ ÎßêÍ≥†, Í∞ÄÏπò ÏûàÎäî ÏÇ¨ÎûåÏù¥ ÎêòÎ†§Í≥† ÌïòÎùº."},
                {"author": "Ïä§Ìã∞Î∏å Ïû°Ïä§", "message": "ÌõåÎ•≠Ìïú ÏùºÏùÑ ÌïòÎäî Ïú†ÏùºÌïú Î∞©Î≤ïÏùÄ ÏûêÏã†Ïù¥ ÌïòÎäî ÏùºÏùÑ ÏÇ¨ÎûëÌïòÎäî Í≤ÉÏù¥Îã§."}
            ];
            
            const randomQuote = quotes[Math.floor(Math.random() * quotes.length)];
            document.getElementById('motivationQuote').innerHTML = `
                <h4>Ïò§ÎäòÏùò ÎèôÍ∏∞Î∂ÄÏó¨</h4>
                <p>"${randomQuote.message}"</p>
                <small>- ${randomQuote.author} -</small>
            `;
        }

        // Ìï† Ïùº Í¥ÄÎ¶¨
        function addTask() {
            const taskId = Date.now();
            tasks.push({
                id: taskId,
                title: '',
                expected_duration: null,
                target_start_time: null,
                additional_info: ''
            });
            renderTasks();
        }

        function removeTask(taskId) {
            tasks = tasks.filter(task => task.id !== taskId);
            renderTasks();
        }

        function renderTasks() {
            const container = document.getElementById('taskList');
            if (tasks.length === 0) {
                container.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">Ìï† ÏùºÏùÑ Ï∂îÍ∞ÄÌï¥Î≥¥ÏÑ∏Ïöî!</p>';
                return;
            }

            let html = '';
            tasks.forEach(task => {
                html += `
                    <div class="task-item">
                        <input type="text" placeholder="Ìï† Ïùº Ï†úÎ™© (ÌïÑÏàò)" value="${task.title}" 
                               onchange="updateTask(${task.id}, 'title', this.value)" required>
                        <input type="number" placeholder="ÏòàÏÉÅ ÏÜåÏöî ÏãúÍ∞Ñ (Î∂Ñ)" value="${task.expected_duration || ''}" 
                               onchange="updateTask(${task.id}, 'expected_duration', this.value ? parseInt(this.value) : null)">
                        <input type="time" placeholder="Î™©Ìëú ÏãúÏûë ÏãúÍ∞Ñ" value="${task.target_start_time || ''}" 
                               onchange="updateTask(${task.id}, 'target_start_time', this.value)">
                        <input type="text" placeholder="Ï∂îÍ∞Ä Ï†ïÎ≥¥ (Ïû•ÏÜå, Ï£ºÏùòÏÇ¨Ìï≠ Îì±)" value="${task.additional_info}" 
                               onchange="updateTask(${task.id}, 'additional_info', this.value)">
                        <button class="btn btn-danger btn-small" onclick="removeTask(${task.id})">ÏÇ≠Ï†ú</button>
                    </div>
                `;
            });
            container.innerHTML = html;
        }

        function updateTask(taskId, field, value) {
            const task = tasks.find(t => t.id === taskId);
            if (task) {
                task[field] = value;
            }
        }

        // Ï±óÎ¥á Í¥ÄÎ†® Ìï®Ïàò
        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            
            if (!message && tasks.length === 0) {
                showAlert('Î©îÏãúÏßÄÎ•º ÏûÖÎ†•ÌïòÍ±∞ÎÇò Ìï† ÏùºÏùÑ Ï∂îÍ∞ÄÌï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }

            // ÏÇ¨Ïö©Ïûê Î©îÏãúÏßÄ ÌëúÏãú
            if (message) {
                addChatMessage('user', message);
                input.value = '';
            }

            // Î°úÎî© ÌëúÏãú
            document.getElementById('chatLoading').style.display = 'block';

            try {
                // Ìï† Ïùº Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ
                const validTasks = tasks.filter(task => task.title.trim() !== '');
                
                console.log('=== ÌîÑÎ°†Ìä∏ÏóîÎìú AI ÏöîÏ≤≠ ÏãúÏûë ===');
                console.log('Ïú†Ìö®Ìïú Ìï† Ïùº:', validTasks);
                
                const chatData = {
                    tasks: validTasks.map(task => ({
                        title: task.title,
                        expected_duration: task.expected_duration,
                        target_start_time: task.target_start_time,
                        additional_info: task.additional_info
                    })),
                    message: message || 'Ïò§Îäò ÏùºÏ†ïÏùÑ Í≥ÑÌöçÌï¥Ï£ºÏÑ∏Ïöî.'
                };

                console.log('AI ÏÑúÎ≤ÑÎ°ú Ï†ÑÏÜ°Ìï† Îç∞Ïù¥ÌÑ∞:', chatData);

                const result = await apiCall('/chat', 'POST', chatData);
                
                console.log('=== AI ÏÑúÎ≤Ñ ÏùëÎãµ Î∂ÑÏÑù ===');
                console.log('Ï†ÑÏ≤¥ ÏùëÎãµ:', result);
                console.log('response:', result.response);
                console.log('plan_table:', result.plan_table);
                console.log('plan_table ÌÉÄÏûÖ:', typeof result.plan_table);
                console.log('plan_table Í∏∏Ïù¥:', result.plan_table ? result.plan_table.length : 'null');
                console.log('summary:', result.summary);
                
                // AI ÏùëÎãµ ÌëúÏãú
                if (result.response) {
                    addChatMessage('assistant', result.response);
                } else {
                    console.warn('AI ÏùëÎãµ ÌÖçÏä§Ìä∏Í∞Ä ÎπÑÏñ¥ÏûàÏùå');
                }
                
                // Í≥ÑÌöçÌëú ÌëúÏãú Î∞è Ï†ÄÏû• ÌôïÏù∏
                if (result.plan_table && Array.isArray(result.plan_table) && result.plan_table.length > 0) {
                    console.log('‚úÖ Ïú†Ìö®Ìïú Í≥ÑÌöçÌëú Îç∞Ïù¥ÌÑ∞ ÏàòÏã†');
                    displayPlanTable(result.plan_table, result.summary);
                    
                    const today = new Date().toISOString().split('T')[0];
                    console.log(`Í≥ÑÌöçÌëú ÏÉùÏÑ± ÏôÑÎ£å - ÎÇ†Ïßú: ${today}`);
                    
                    showAlert('AIÍ∞Ä ÏùºÏ†ïÏùÑ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Í≥ÑÌöçÌñàÏäµÎãàÎã§!', 'success');
                    
                    // Ï¶âÏãú Ï†ÄÏû• ÏÉÅÌÉú ÌôïÏù∏
                    setTimeout(async () => {
                        try {
                            const savedPlans = await apiCall('/plan');
                            console.log('Ï†ÄÏû•Îêú Í≥ÑÌöçÌëú Î™©Î°ù:', savedPlans);
                        } catch (e) {
                            console.log('Ï†ÄÏû•Îêú Í≥ÑÌöçÌëú ÌôïÏù∏ Ïã§Ìå®:', e);
                        }
                    }, 500);
                    
                } else {
                    console.warn('‚ùå Í≥ÑÌöçÌëú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÍ±∞ÎÇò ÎπÑÏñ¥ÏûàÏùå');
                    if (result.plan_table) {
                        console.log('plan_table ÎÇ¥Ïö©:', result.plan_table);
                    }
                    addChatMessage('assistant', 'AIÍ∞Ä Í≥ÑÌöçÌëúÎ•º ÏÉùÏÑ±ÌïòÏßÄ Î™ªÌñàÏäµÎãàÎã§. Ìï† ÏùºÏùÑ Îçî Íµ¨Ï≤¥Ï†ÅÏúºÎ°ú ÏûëÏÑ±Ìï¥Î≥¥ÏÑ∏Ïöî.');
                }

                // ÎåÄÏãúÎ≥¥Îìú ÏÉàÎ°úÍ≥†Ïπ® (Í≥ÑÌöçÌëú Ï†ÄÏû• ÌõÑ)
                setTimeout(() => {
                    console.log('ÎåÄÏãúÎ≥¥Îìú ÏÉàÎ°úÍ≥†Ïπ® ÏãúÏûë...');
                    loadDashboard();
                }, 2000); // ÏãúÍ∞ÑÏùÑ ÎäòÎ†§ÏÑú Ï†ÄÏû• ÏôÑÎ£å ÎåÄÍ∏∞
                
            } catch (error) {
                console.error('AI ÌÜµÏã† Ïò§Î•ò ÏÉÅÏÑ∏:', error);
                
                // Íµ¨Ï≤¥Ï†ÅÏù∏ Ïò§Î•ò Î©îÏãúÏßÄ ÌëúÏãú
                if (error.message.includes('Ï±óÎ¥á ÏÑúÎ≤Ñ ÏöîÏ≤≠ Ïã§Ìå®')) {
                    addChatMessage('assistant', '‚ùå AI ÏÑúÎ≤ÑÏóê Ïó∞Í≤∞Ìï† Ïàò ÏóÜÏäµÎãàÎã§. ÏÑúÎ≤Ñ ÏÉÅÌÉúÎ•º ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.');
                    showAlert('AI ÏÑúÎ≤Ñ Ïó∞Í≤∞ Ïã§Ìå®: ' + error.message, 'error');
                } else if (error.message.includes('timeout')) {
                    addChatMessage('assistant', '‚è±Ô∏è AI ÏÑúÎ≤Ñ ÏùëÎãµ ÏãúÍ∞ÑÏù¥ Ï¥àÍ≥ºÎêòÏóàÏäµÎãàÎã§. Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                } else if (error.message.includes('500')) {
                    addChatMessage('assistant', 'üîß AI ÏÑúÎ≤ÑÏóêÏÑú ÎÇ¥Î∂Ä Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.');
                } else {
                    addChatMessage('assistant', '‚ö†Ô∏è AI ÏÑúÎ≤Ñ ÌÜµÏã† Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§: ' + error.message);
                }
                
                // Ïò§Î•ò Î∞úÏÉù Ïãú Ìï† Ïùº Î™©Î°ù Ïú†ÏßÄ
                console.log('Ïò§Î•ò Î∞úÏÉù - ÏûÖÎ†•Ìïú Ìï† Ïùº:', validTasks);
                
            } finally {
                document.getElementById('chatLoading').style.display = 'none';
            }
        }

        function addChatMessage(role, content) {
            const messagesContainer = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            
            messageDiv.innerHTML = `
                <div class="message-content">${content}</div>
            `;
            
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function displayPlanTable(planTable, summary) {
            let html = '<div class="plan-table"><h4>ÏÉùÏÑ±Îêú ÏùºÏ†ïÌëú</h4>';
            
            planTable.forEach(item => {
                html += `
                    <div class="plan-item">
                        <span class="plan-time">${item.time || ''}</span>
                        <div class="plan-content">
                            <strong>${item.title || item.task || 'ÏùºÏ†ï'}</strong>
                            ${item.description ? `<br><small>${item.description}</small>` : ''}
                        </div>
                    </div>
                `;
            });

            if (summary) {
                html += `<div style="margin-top: 15px; padding: 15px; background: #e8f4fd; border-radius: 8px;">
                    <strong>ÏöîÏïΩ:</strong> ${summary}
                </div>`;
            }
            
            html += '</div>';
            
            addChatMessage('assistant', html);
        }

        // Î£®Ìã¥ Í¥ÄÎ¶¨
        async function loadRoutines() {
            try {
                console.log('Î£®Ìã¥ Î™©Î°ù Î°úÎî© ÏãúÏûë...');
                const routines = await apiCall('/routine');
                console.log('Î∞õÏùÄ Î£®Ìã¥ Îç∞Ïù¥ÌÑ∞:', routines);
                
                // Í∞Å ÏöîÏùºÎ≥Ñ Î£®Ìã¥ Îç∞Ïù¥ÌÑ∞ ÌôïÏù∏
                Object.keys(routines).forEach(day => {
                    console.log(`${day} Î£®Ìã¥:`, routines[day]);
                    if (routines[day]) {
                        routines[day].forEach((routine, index) => {
                            console.log(`  ${index}: ID=${routine.routine_id}, Ï†úÎ™©=${routine.title}`);
                        });
                    }
                });
                
                renderRoutines(routines);
            } catch (error) {
                console.error('Î£®Ìã¥ Î°úÎî© Ïò§Î•ò:', error);
                document.getElementById('routineWeek').innerHTML = '<p>Î£®Ìã¥ÏùÑ Î∂àÎü¨Ïò¨ Ïàò ÏóÜÏäµÎãàÎã§.</p>';
            }
        }

        function renderRoutines(routines) {
            const days = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
            const dayNames = ['ÏõîÏöîÏùº', 'ÌôîÏöîÏùº', 'ÏàòÏöîÏùº', 'Î™©ÏöîÏùº', 'Í∏àÏöîÏùº', 'ÌÜ†ÏöîÏùº', 'ÏùºÏöîÏùº'];
            
            let html = '';
            
            days.forEach((day, index) => {
                html += `
                    <div class="day-card">
                        <div class="day-title">${dayNames[index]}</div>
                        <div class="routines-list">
                `;
                
                const dayRoutines = routines && routines[day] ? routines[day] : [];
                
                if (dayRoutines.length === 0) {
                    html += '<p style="color: #999; text-align: center; padding: 20px;">Î£®Ìã¥Ïù¥ ÏóÜÏäµÎãàÎã§</p>';
                } else {
                    dayRoutines.forEach(routine => {
                        console.log(`${day} Î£®Ìã¥:`, routine); // ÎîîÎ≤ÑÍπÖÏö©
                        const routineId = routine.routine_id || routine.id || 'unknown';
                        
                        html += `
                            <div class="routine-item">
                                <div class="routine-info">
                                    <div class="routine-title">${routine.title}</div>
                                    <div class="routine-time">
                                        ${routine.routine_time ? formatTime(routine.routine_time) : ''} 
                                        ${routine.time_taken_minutes ? `(${routine.time_taken_minutes}Î∂Ñ)` : ''}
                                        ${routine.time_zone ? `- ${routine.time_zone}` : ''}
                                    </div>
                                </div>
                                <div class="routine-actions">
                                    <button class="btn btn-secondary btn-small" onclick="editRoutine('${day}', '${routineId}')">ÏàòÏ†ï</button>
                                    <button class="btn btn-danger btn-small" onclick="deleteRoutine('${day}', '${routineId}')">ÏÇ≠Ï†ú</button>
                                </div>
                            </div>
                        `;
                    });
                }
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('routineWeek').innerHTML = html;
        }

        let editMode = {
            isEditing: false,
            week: null,
            routineId: null
        };

        async function editRoutine(week, routineId) {
            try {
                console.log(`Î£®Ìã¥ ÏàòÏ†ï ÏãúÏûë: ${week}/${routineId}`);
                const routine = await apiCall(`/routine/${week}/${routineId}`);
                console.log('Í∞ÄÏ†∏Ïò® Î£®Ìã¥ Îç∞Ïù¥ÌÑ∞:', routine);
                
                // Ìé∏Ïßë Î™®Îìú ÏÑ§Ï†ï
                editMode.isEditing = true;
                editMode.week = week;
                editMode.routineId = routineId;
                
                // Î™®Îã¨Ïóê Í∏∞Ï°¥ Îç∞Ïù¥ÌÑ∞ Ï±ÑÏö∞Í∏∞
                document.getElementById('routineTitle').value = routine.title || '';
                document.getElementById('routineTime').value = routine.routine_time ? formatTime(routine.routine_time) : '';
                document.getElementById('routineDuration').value = routine.time_taken_minutes || '';
                document.getElementById('routineTimeZone').value = routine.time_zone || '';
                
                // ÏöîÏùº Ï≤¥ÌÅ¨Î∞ïÏä§Îäî ÌòÑÏû¨ ÏöîÏùºÎßå Ï≤¥ÌÅ¨
                ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].forEach(day => {
                    document.getElementById(day).checked = (day === week);
                });
                
                // Î™®Îã¨ Ï†úÎ™© Î≥ÄÍ≤Ω
                document.querySelector('#routineModal .modal-title').textContent = 'Î£®Ìã¥ ÏàòÏ†ï';
                
                document.getElementById('routineModal').style.display = 'block';
            } catch (error) {
                console.error('Î£®Ìã¥ ÏàòÏ†ï Ïò§Î•ò:', error);
                showAlert(error.message, 'error');
            }
        }

        async function handleRoutineSubmit() {
            if (editMode.isEditing) {
                // ÏàòÏ†ï Î™®Îìú
                const updateData = {
                    title: document.getElementById('routineTitle').value,
                    routine_time: document.getElementById('routineTime').value || null,
                    time_taken_minutes: document.getElementById('routineDuration').value ? parseInt(document.getElementById('routineDuration').value) : null,
                    time_zone: document.getElementById('routineTimeZone').value || null
                };

                console.log('Î£®Ìã¥ ÏàòÏ†ï Îç∞Ïù¥ÌÑ∞:', updateData);

                try {
                    await apiCall(`/routine/${editMode.week}/${editMode.routineId}`, 'PUT', updateData);
                    showAlert('Î£®Ìã¥Ïù¥ ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§!', 'success');
                } catch (error) {
                    console.error('Î£®Ìã¥ ÏàòÏ†ï Ïò§Î•ò:', error);
                    showAlert(error.message, 'error');
                    return;
                }
            } else {
                // ÏÉùÏÑ± Î™®Îìú
                const formData = {
                    title: document.getElementById('routineTitle').value,
                    routine_time: document.getElementById('routineTime').value || null,
                    time_taken_minutes: document.getElementById('routineDuration').value ? parseInt(document.getElementById('routineDuration').value) : null,
                    time_zone: document.getElementById('routineTimeZone').value || null,
                    monday: document.getElementById('monday').checked,
                    tuesday: document.getElementById('tuesday').checked,
                    wednesday: document.getElementById('wednesday').checked,
                    thursday: document.getElementById('thursday').checked,
                    friday: document.getElementById('friday').checked,
                    saturday: document.getElementById('saturday').checked,
                    sunday: document.getElementById('sunday').checked
                };

                console.log('Î£®Ìã¥ Ï∂îÍ∞Ä ÏöîÏ≤≠:', formData);

                try {
                    await apiCall('/routine', 'POST', formData);
                    showAlert('Î£®Ìã¥Ïù¥ Ï∂îÍ∞ÄÎêòÏóàÏäµÎãàÎã§!', 'success');
                } catch (error) {
                    console.error('Î£®Ìã¥ Ï∂îÍ∞Ä Ïò§Î•ò:', error);
                    showAlert(error.message, 'error');
                    return;
                }
            }

            // ÏÑ±Í≥µ Ïãú Í≥µÌÜµ Ï≤òÎ¶¨
            closeModal('routineModal');
            loadRoutines();
            resetRoutineModal();
        }

        function resetRoutineModal() {
            // Ìé∏Ïßë Î™®Îìú Ï¥àÍ∏∞Ìôî
            editMode.isEditing = false;
            editMode.week = null;
            editMode.routineId = null;
            
            // Î™®Îã¨ Ï†úÎ™© Ï¥àÍ∏∞Ìôî
            document.querySelector('#routineModal .modal-title').textContent = 'Î£®Ìã¥ Ï∂îÍ∞Ä';
            
            // Ìèº Ï¥àÍ∏∞Ìôî
            document.getElementById('routineForm').reset();
        }

        function showAddRoutineModal() {
            resetRoutineModal();
            document.getElementById('routineModal').style.display = 'block';
        }

        async function deleteRoutine(week, routineId) {
            if (!confirm('Ïù¥ Î£®Ìã¥ÏùÑ ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;

            try {
                await apiCall(`/routine/${week}/${routineId}`, 'DELETE');
                loadRoutines();
                showAlert('Î£®Ìã¥Ïù¥ ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§!', 'success');
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        // Í≥ÑÌöçÌëú Í¥ÄÎ¶¨
        async function loadPlans() {
            try {
                const plans = await apiCall('/plan');
                renderPlans(plans);
            } catch (error) {
                document.getElementById('plansList').innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">Ï†ÄÏû•Îêú Í≥ÑÌöçÌëúÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>';
            }
        }

        function renderPlans(plans) {
            let html = '';
            
            if (plans && plans.length > 0) {
                plans.forEach(plan => {
                    html += `
                        <div class="plan-item" style="margin-bottom: 15px;">
                            <div class="plan-content">
                                <strong>${plan.date}</strong>
                                <div style="margin-top: 8px;">
                                    <button class="btn btn-primary btn-small" onclick="viewPlan('${plan.date}')">Î≥¥Í∏∞</button>
                                    <button class="btn btn-danger btn-small" onclick="deletePlan('${plan.date}')">ÏÇ≠Ï†ú</button>
                                </div>
                            </div>
                        </div>
                    `;
                });
            } else {
                html = '<p style="text-align: center; color: #666; padding: 40px;">Ï†ÄÏû•Îêú Í≥ÑÌöçÌëúÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>';
            }
            
            document.getElementById('plansList').innerHTML = html;
        }

        async function viewPlan(date) {
            try {
                const plan = await apiCall(`/plan/${date}`);
                let html = `<h4>${date} Í≥ÑÌöçÌëú</h4>`;
                
                if (plan.plan_table && plan.plan_table.length > 0) {
                    html += '<div class="plan-table">';
                    plan.plan_table.forEach(item => {
                        html += `
                            <div class="plan-item">
                                <span class="plan-time">${item.time || ''}</span>
                                <div class="plan-content">
                                    <strong>${item.title || item.task || 'ÏùºÏ†ï'}</strong>
                                    ${item.description ? `<br><small>${item.description}</small>` : ''}
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
                
                if (plan.summary) {
                    html += `<div style="margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <strong>ÏöîÏïΩ:</strong> ${plan.summary}
                    </div>`;
                }
                
                document.getElementById('profileContent').innerHTML = html;
                document.getElementById('profileModal').style.display = 'block';
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        async function deletePlan(date) {
            if (!confirm('Ïù¥ Í≥ÑÌöçÌëúÎ•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) return;

            try {
                await apiCall(`/plan/${date}`, 'DELETE');
                loadPlans();
                showAlert('Í≥ÑÌöçÌëúÍ∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§!', 'success');
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        // ÌîÑÎ°úÌïÑ Í¥ÄÎ¶¨
        let profileMode = {
            isEditing: false,
            currentUser: null
        };

        async function showProfile() {
            try {
                const user = await apiCall('/me');
                profileMode.currentUser = user;
                profileMode.isEditing = false;
                
                // Ï¥àÍ∏∞ ÌôîÎ©¥: ÏÇ¨Ïö©Ïûê Ï†ïÎ≥¥ + ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏
                document.getElementById('profileContent').innerHTML = `
                    <div class="user-info-display">
                        <div class="form-group">
                            <strong>ÏïÑÏù¥Îîî:</strong> ${user.login_id}
                        </div>
                        <div class="form-group">
                            <strong>Ïù¥Î¶Ñ:</strong> ${user.name}
                        </div>
                        <div class="form-group">
                            <strong>ÎÇòÏù¥:</strong> ${user.age}
                        </div>
                        <div class="form-group">
                            <strong>Ïù¥Î©îÏùº:</strong> ${user.email}
                        </div>
                        <div class="form-group">
                            <strong>Í∞ÄÏûÖÏùº:</strong> ${new Date(user.created_at).toLocaleDateString()}
                        </div>
                        
                        <hr style="margin: 20px 0;">
                        
                        <h4>Ï†ïÎ≥¥ ÏàòÏ†ï</h4>
                        <p style="color: #666; font-size: 14px;">Ï†ïÎ≥¥Î•º ÏàòÏ†ïÌïòÎ†§Î©¥ ÌòÑÏû¨ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.</p>
                        
                        <div class="form-group">
                            <label class="form-label">ÌòÑÏû¨ ÎπÑÎ∞ÄÎ≤àÌò∏</label>
                            <input type="password" id="currentPassword" class="form-input" placeholder="ÌòÑÏû¨ ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                        </div>
                        
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="btn btn-primary" onclick="verifyPasswordForEdit()">Ï†ïÎ≥¥ ÏàòÏ†ï</button>
                            <button class="btn btn-danger" onclick="verifyPasswordForWithdraw()">ÌöåÏõêÌÉàÌá¥</button>
                        </div>
                    </div>
                `;
                
                document.getElementById('profileModal').style.display = 'block';
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        async function verifyPasswordForEdit() {
            const password = document.getElementById('currentPassword').value.trim();
            
            if (!password) {
                showAlert('ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }
            
            try {
                await apiCall('/me', 'POST', { password });
                showEditProfileForm();
            } catch (error) {
                showAlert('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.', 'error');
            }
        }

        function showEditProfileForm() {
            profileMode.isEditing = true;
            const user = profileMode.currentUser;
            
            document.getElementById('profileContent').innerHTML = `
                <h4>Ï†ïÎ≥¥ ÏàòÏ†ï</h4>
                <form id="editProfileForm">
                    <div class="form-group">
                        <label class="form-label">ÏïÑÏù¥Îîî</label>
                        <input type="text" class="form-input" value="${user.login_id}" disabled style="background: #f8f9fa;">
                        <small style="color: #666;">ÏïÑÏù¥ÎîîÎäî Î≥ÄÍ≤ΩÌï† Ïàò ÏóÜÏäµÎãàÎã§.</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Ïù¥Î¶Ñ</label>
                        <input type="text" id="editName" class="form-input" value="${user.name}">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÎÇòÏù¥</label>
                        <input type="number" id="editAge" class="form-input" value="${user.age}" min="0">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Ïù¥Î©îÏùº</label>
                        <input type="email" id="editEmail" class="form-input" value="${user.email}">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏ (Î≥ÄÍ≤ΩÌïòÏßÄ ÏïäÏúºÎ†§Î©¥ ÎπÑÏõåÎëêÏÑ∏Ïöî)</label>
                        <input type="password" id="editPassword" class="form-input" placeholder="ÏÉà ÎπÑÎ∞ÄÎ≤àÌò∏ (8Ïûê Ïù¥ÏÉÅ, ÌäπÏàòÎ¨∏Ïûê Ìè¨Ìï®)">
                        <small style="color: #666;">ÎπÑÎ∞ÄÎ≤àÌò∏Î•º Î≥ÄÍ≤ΩÌïòÏßÄ ÏïäÏúºÎ†§Î©¥ Ïù¥ ÌïÑÎìúÎ•º ÎπÑÏõåÎëêÏÑ∏Ïöî.</small>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                        <button type="button" class="btn btn-primary" onclick="updateProfile()">Ï†ÄÏû•</button>
                        <button type="button" class="btn btn-secondary" onclick="showProfile()">Ï∑®ÏÜå</button>
                    </div>
                </form>
            `;
        }

        async function updateProfile() {
            const updateData = {
                name: document.getElementById('editName').value.trim(),
                age: parseInt(document.getElementById('editAge').value),
                email: document.getElementById('editEmail').value.trim(),
            };
            
            const newPassword = document.getElementById('editPassword').value.trim();
            if (newPassword) {
                if (newPassword.length < 8) {
                    showAlert('ÎπÑÎ∞ÄÎ≤àÌò∏Îäî 8Ïûê Ïù¥ÏÉÅÏù¥Ïñ¥Ïïº Ìï©ÎãàÎã§.', 'error');
                    return;
                }
                if (newPassword.replace(/[^a-zA-Z0-9]/g, '') === newPassword) {
                    showAlert('ÎπÑÎ∞ÄÎ≤àÌò∏Ïóê ÌäπÏàòÎ¨∏ÏûêÎ•º 1Í∞ú Ïù¥ÏÉÅ Ìè¨Ìï®Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                    return;
                }
                updateData.password = newPassword;
            }
            
            if (!updateData.name || !updateData.email) {
                showAlert('Ïù¥Î¶ÑÍ≥º Ïù¥Î©îÏùºÏùÄ ÌïÑÏàò ÏûÖÎ†• Ìï≠Î™©ÏûÖÎãàÎã§.', 'error');
                return;
            }
            
            try {
                const updatedUser = await apiCall('/me', 'PUT', updateData);
                profileMode.currentUser = updatedUser;
                
                // Ìó§ÎçîÏùò ÏÇ¨Ïö©Ïûê Ïù¥Î¶ÑÎèÑ ÏóÖÎç∞Ïù¥Ìä∏
                document.getElementById('userWelcome').textContent = `${updatedUser.name}Îãò ÌôòÏòÅÌï©ÎãàÎã§!`;
                
                showAlert('Ï†ïÎ≥¥Í∞Ä ÏÑ±Í≥µÏ†ÅÏúºÎ°ú ÏàòÏ†ïÎêòÏóàÏäµÎãàÎã§.', 'success');
                showProfile(); // ÏàòÏ†ïÎêú Ï†ïÎ≥¥Î°ú Îã§Ïãú ÌëúÏãú
            } catch (error) {
                showAlert(error.message, 'error');
            }
        }

        async function verifyPasswordForWithdraw() {
            const password = document.getElementById('currentPassword').value.trim();
            
            if (!password) {
                showAlert('ÎπÑÎ∞ÄÎ≤àÌò∏Î•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.', 'error');
                return;
            }
            
            try {
                await apiCall('/me', 'POST', { password });
                
                if (confirm('Ï†ïÎßêÎ°ú ÌÉàÌá¥ÌïòÏãúÍ≤†ÏäµÎãàÍπå? Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.\n\nÌÉàÌá¥ÌïòÏãúÎ©¥:\n- Î™®Îì† Î£®Ìã¥Í≥º Í≥ÑÌöçÌëúÍ∞Ä ÏÇ≠Ï†úÎê©ÎãàÎã§\n- Í≥ÑÏ†ïÏùÑ Î≥µÍµ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§')) {
                    await apiCall('/withdraw', 'DELETE');
                    alert('ÌöåÏõêÌÉàÌá¥Í∞Ä ÏôÑÎ£åÎêòÏóàÏäµÎãàÎã§.');
                    logout();
                }
            } catch (error) {
                showAlert('ÎπÑÎ∞ÄÎ≤àÌò∏Í∞Ä ÏùºÏπòÌïòÏßÄ ÏïäÏäµÎãàÎã§.', 'error');
            }
        }

        // Î™®Îã¨ Í¥ÄÎ¶¨
        function showAddRoutineModal() {
            document.getElementById('routineModal').style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà
        document.getElementById('loginFormElement').addEventListener('submit', function(e) {
            e.preventDefault();
            login();
        });

        document.getElementById('registerFormElement').addEventListener('submit', function(e) {
            e.preventDefault();
            register();
        });

        document.getElementById('routineForm').addEventListener('submit', function(e) {
            e.preventDefault();
            handleRoutineSubmit(); // ÌÜµÌï©Îêú Ìï®Ïàò ÏÇ¨Ïö©
        });

        document.getElementById('chatInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
        window.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });

        // Ïï± Ï¥àÍ∏∞Ìôî
        document.addEventListener('DOMContentLoaded', function() {
            // Ï†ÄÏû•Îêú ÌÜ†ÌÅ∞ ÌôïÏù∏
            const savedToken = localStorage.getItem('authToken');
            if (savedToken) {
                authToken = savedToken;
                // ÌÜ†ÌÅ∞ Ïú†Ìö®ÏÑ± Í≤ÄÏÇ¨
                apiCall('/me').then(user => {
                    currentUser = user;
                    showMainApp();
                    loadDashboard();
                    loadRoutines();
                }).catch(() => {
                    localStorage.removeItem('authToken');
                    authToken = null;
                });
            }
        });
    </script>
</body>
</html>